<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المنتجات - مكتبة الرواد</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e3d59;
            --primary-light: #2a5a87;
            --secondary-color: #ff6b35;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --gray-color: #6c757d;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(30deg);
        }

        h1 {
            margin-bottom: 0.5rem;
            font-size: 2.2rem;
            position: relative;
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-align: center;
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #34ce57);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #e74c3c);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #ffd761);
            color: var(--dark-color);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #5bc0de);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #8a939b);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .form-container {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        }

        .form-title {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f4f8;
            position: relative;
        }

        .form-title::after {
            content: "";
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 60px;
            height: 2px;
            background: var(--secondary-color);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.9rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 61, 89, 0.1);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .products-section {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }

        .section-title {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f4f8;
            position: relative;
        }

        .section-title::after {
            content: "";
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 60px;
            height: 2px;
            background: var(--secondary-color);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: var(--transition);
            border: 1px solid #eee;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .product-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--secondary-color);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 10;
        }

        .product-image {
            height: 200px;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e1eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0aec0;
            font-size: 2.5rem;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-image::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(0,0,0,0.05));
        }

        .product-info {
            padding: 1.5rem;
        }

        .product-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .product-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .original-price {
            text-decoration: line-through;
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .discount-badge {
            background: var(--danger-color);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .product-category {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 1rem;
            color: var(--gray-color);
        }

        .product-description {
            color: var(--gray-color);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .product-rating {
            margin-bottom: 1rem;
            color: #ffc107;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rating-text {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            transform: translateX(100%);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            background: var(--success-color);
            color: white;
        }

        .notification-error {
            background: var(--danger-color);
            color: white;
        }

        .notification-info {
            background: var(--info-color);
            color: white;
        }

        .hidden {
            display: none;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            color: var(--gray-color);
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: var(--dark-color);
        }

        .code-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .code-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .code-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            transform: translateY(50px);
            transition: var(--transition);
        }

        .code-modal.active .code-content {
            transform: translateY(0);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .close-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .close-btn:hover {
            background: #c82333;
            transform: rotate(90deg);
        }

        .code-body {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
            border: 1px solid #e9ecef;
            margin-bottom: 1.5rem;
        }

        .code-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .footer {
            text-align: center;
            margin-top: 3rem;
            padding: 1.5rem;
            color: var(--gray-color);
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        .code-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }
        
        .code-tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 0.5rem;
            border-radius: 5px 5px 0 0;
            transition: var(--transition);
            white-space: nowrap;
        }

        .code-tab.active {
            background: white;
            border-color: #ddd;
            color: var(--primary-color);
            font-weight: 600;
        }

        .copy-btn {
            position: relative;
            overflow: hidden;
        }

        .copy-btn.copied::before {
            content: '✓';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--success-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
        }

        .image-upload-container {
            margin-bottom: 1.5rem;
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }

        .image-upload-container:hover {
            border-color: var(--primary-color);
        }

        .image-upload-label {
            display: block;
            cursor: pointer;
            color: var(--primary-color);
            font-weight: 600;
        }

        .image-upload-label i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--primary-light);
        }

        .image-preview {
            margin-top: 1rem;
            display: none;
            max-width: 100%;
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
        }

        .image-preview img {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
        }

        .remove-image-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .remove-image-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .image-size-warning {
            font-size: 0.8rem;
            color: var(--gray-color);
            margin-top: 0.5rem;
        }

        .search-container {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 0.9rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: #e9ecef;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .filter-btn:hover {
            background: var(--primary-light);
            color: white;
        }

        .code-section {
            display: none;
        }

        .code-section.active {
            display: block;
        }

        @media (max-width: 768px) {
            .admin-actions {
                grid-template-columns: 1fr;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions, .code-actions {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .form-actions .btn, .code-actions .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .search-container {
                flex-direction: column;
            }
        }

        [dir="rtl"] .fa {
            transform: scaleX(-1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>نظام إدارة المنتجات - مكتبة الرواد</h1>
            <p class="header-subtitle">إضافة وتعديل المنتجات المعروضة في المتجر</p>
        </header>

        <div class="admin-actions">
            <button class="btn btn-primary" onclick="showProductForm()">
                <i class="fas fa-plus"></i> إضافة منتج جديد
            </button>
            <button class="btn btn-success" onclick="syncWithMainPage()">
                <i class="fas fa-sync"></i> مزامنة مع الصفحة الرئيسية
            </button>
            <button class="btn btn-info" onclick="showCodeModal()">
                <i class="fas fa-code"></i> نسخ أكواد المنتجات
            </button>
            <button class="btn btn-warning" onclick="addSampleProducts()">
                <i class="fas fa-download"></i> إضافة منتجات نموذجية
            </button>
            <button class="btn btn-danger" onclick="clearAllProducts()">
                <i class="fas fa-trash"></i> حذف جميع المنتجات
            </button>
            <button class="btn btn-secondary" onclick="exportProducts()">
                <i class="fas fa-file-export"></i> تصدير المنتجات
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                <i class="fas fa-home"></i> العودة للمتجر
            </button>
        </div>

        <div class="form-container hidden" id="productForm">
            <h2 class="form-title" id="formTitle">إضافة منتج جديد</h2>
            
            <div class="form-group">
                <label for="productName">اسم المنتج</label>
                <input type="text" id="productName" required placeholder="أدخل اسم المنتج">
            </div>
            
            <div class="form-group">
                <label for="productPrice">السعر الأصلي (جنيه)</label>
                <input type="number" id="productPrice" min="0" required placeholder="أدخل السعر الأصلي">
            </div>
            
            <div class="form-group">
                <label for="productDiscount">نسبة الخصم (%)</label>
                <input type="number" id="productDiscount" min="0" max="100" value="0" placeholder="أدخل نسبة الخصم">
            </div>
            
            <div class="form-group">
                <label for="productCategory">التصنيف</label>
                <select id="productCategory" required>
                    <option value="books">الكتب الدراسية</option>
                    <option value="stationery">المستلزمات المكتبية</option>
                    <option value="bags">الحقائب المدرسية</option>
                    <option value="gifts">الهدايا</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="productDescription">الوصف</label>
                <textarea id="productDescription" required placeholder="أدخل وصف المنتج"></textarea>
            </div>
            
            <div class="form-group">
                <label for="productRating">التقييم (من 5)</label>
                <input type="number" id="productRating" min="1" max="5" value="4" required>
            </div>
            
            <div class="form-group">
                <label for="productBadge">علامة مميزة (اختياري)</label>
                <input type="text" id="productBadge" placeholder="جديد، الأكثر مبيعاً، إلخ...">
            </div>
            
            <div class="form-group">
                <label>صورة المنتج</label>
                <div class="image-upload-container">
                    <label for="productImage" class="image-upload-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        انقر لرفع صورة المنتج
                        <input type="file" id="productImage" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    </label>
                    <p class="image-size-warning">الحجم الأقصى للصورة: 5MB، الأبعاد: 2000x2000 بكسل</p>
                    <div class="image-preview" id="imagePreview">
                        <img id="previewImage" src="" alt="معاينة الصورة">
                        <button type="button" class="remove-image-btn" onclick="removeImage()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <input type="hidden" id="productId">
            <input type="hidden" id="productImageData">
            
            <div class="form-actions">
                <button class="btn btn-success" onclick="saveProduct()">
                    <i class="fas fa-save"></i> حفظ المنتج
                </button>
                <button class="btn btn-danger" onclick="hideProductForm()">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>

        <div class="products-section">
            <h2 class="section-title">المنتجات الحالية</h2>
            
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="ابحث عن منتج..." oninput="filterProducts()">
                <button class="btn btn-info" onclick="clearSearch()">
                    <i class="fas fa-times"></i> مسح البحث
                </button>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="setCategoryFilter('all')">الكل</button>
                <button class="filter-btn" onclick="setCategoryFilter('books')">الكتب الدراسية</button>
                <button class="filter-btn" onclick="setCategoryFilter('stationery')">المستلزمات المكتبية</button>
                <button class="filter-btn" onclick="setCategoryFilter('bags')">الحقائب المدرسية</button>
                <button class="filter-btn" onclick="setCategoryFilter('gifts')">الهدايا</button>
            </div>
            
            <div class="products-grid" id="productsList">
                <!-- سيتم ملؤها بواسطة JavaScript -->
            </div>
        </div>

        <div class="footer">
            <p>© 2025 نظام إدارة المنتجات - مكتبة الرواد. جميع الحقوق محفوظة.</p>
            <p>تم التطوير بواسطة فريق الثقيلة المتخصص</p>
            <p>
                <a href="#" style="color: var(--primary-color); text-decoration: none;">سياسة الخصوصية</a> | 
                <a href="#" style="color: var(--primary-color); text-decoration: none;">شروط الخدمة</a>
            </p>
        </div>
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationMessage"></span>
        <button class="close-btn" onclick="hideNotification()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="code-modal" id="codeModal">
        <div class="code-content">
            <div class="code-header">
                <h2>أكواد المنتجات</h2>
                <button class="close-btn" onclick="hideCodeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="code-tabs">
                <div class="code-tab active" data-tab="jsCode">كود JavaScript</div>
                <div class="code-tab" data-tab="htmlCode">كود HTML للصفحة</div>
            </div>
            
            <div class="code-section active" id="jsCode">
                <div class="code-body" id="jsCodeContent">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
                <div class="code-actions">
                    <button class="btn btn-info copy-btn" onclick="copyCode('jsCodeContent', this)">
                        <i class="fas fa-copy"></i> نسخ كود JavaScript
                    </button>
                </div>
            </div>
            
            <div class="code-section" id="htmlCode">
                <div class="code-body" id="htmlCodeContent">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
                <div class="code-actions">
                    <button class="btn btn-info copy-btn" onclick="copyCode('htmlCodeContent', this)">
                        <i class="fas fa-copy"></i> نسخ كود HTML
                    </button>
                </div>
            </div>
            
            <div class="code-actions">
                <button class="btn btn-danger" onclick="hideCodeModal()">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBLAq1eYQ67zKLGs2my5_paM3GByrfPwYU",
            authDomain: "rawad-library.firebaseapp.com",
            projectId: "rawad-library",
            storageBucket: "rawad-library.firebasestorage.app",
            messagingSenderId: "981528745525",
            appId: "1:981528745525:web:2c2cab42b19c107ad2437c",
            measurementId: "G-4HDXZ6STTW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideCodeModal();
                    hideProductForm();
                    hideNotification();
                }
            });
            
            document.getElementById('codeModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideCodeModal();
                }
            });
            
            document.querySelectorAll('.code-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchCodeTab(this.getAttribute('data-tab'));
                });
            });
        });

        // المتغيرات العامة
        let currentCategoryFilter = 'all';
        let currentSearchTerm = '';
        let unsubscribeProducts = null;

        // تعقيم المدخلات لمنع XSS
        function sanitizeInput(input) {
            return input.replace(/[<>"'&]/g, '');
        }

        // تحميل المنتجات من Firebase مع التحديث التلقائي
        function loadProducts() {
            const productsList = document.getElementById('productsList');
            
            // إلغاء أي اشتراك سابق
            if (unsubscribeProducts) {
                unsubscribeProducts();
            }
            
            // الاشتراك في التحديثات الفورية
            unsubscribeProducts = db.collection('products')
                .onSnapshot((snapshot) => {
                    const products = [];
                    snapshot.forEach((doc) => {
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderProducts(products);
                }, (error) => {
                    console.error("Error loading products: ", error);
                    showNotification('حدث خطأ في تحميل المنتجات', 'error');
                });
        }

        // عرض المنتجات في الشبكة
        function renderProducts(products) {
            const productsList = document.getElementById('productsList');
            
            const filteredProducts = products.filter(product => {
                const matchesCategory = currentCategoryFilter === 'all' || product.category === currentCategoryFilter;
                const matchesSearch = product.name.toLowerCase().includes(currentSearchTerm.toLowerCase()) || 
                                    product.description.toLowerCase().includes(currentSearchTerm.toLowerCase());
                return matchesCategory && matchesSearch;
            });
            
            if (filteredProducts.length === 0) {
                productsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>لا توجد منتجات حالياً</h3>
                        <p>لم يتم إضافة أي منتجات بعد. قم بإضافة منتجات جديدة لبدء إدارة متجرك.</p>
                        <button class="btn btn-primary" onclick="showProductForm()">
                            <i class="fas fa-plus"></i> إضافة منتج جديد
                        </button>
                    </div>
                `;
                return;
            }
            
            productsList.innerHTML = filteredProducts.map(product => {
                const finalPrice = product.discount > 0 
                    ? product.price - (product.price * product.discount / 100)
                    : product.price;
                    
                return `
                <div class="product-card">
                    ${product.badge ? `<span class="product-badge">${sanitizeInput(product.badge)}</span>` : ''}
                    <div class="product-image">
                        ${product.imageUrl ? `<img src="${product.imageUrl}" alt="${sanitizeInput(product.name)}">` : getCategoryIcon(product.category)}
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${sanitizeInput(product.name)}</h3>
                        <div class="product-price">
                            ${product.discount > 0 ? `
                                <span class="discount-badge">خصم ${product.discount}%</span>
                                <span class="original-price">${product.price.toFixed(2)} جنيه</span>
                            ` : ''}
                            ${finalPrice.toFixed(2)} جنيه
                        </div>
                        <span class="product-category">${getCategoryName(product.category)}</span>
                        <div class="product-rating">
                            ${generateStarRating(product.rating)}
                            <span class="rating-text">(${product.rating}.0)</span>
                        </div>
                        <p class="product-description">${sanitizeInput(product.description)}</p>
                        <div class="product-actions">
                            <button class="btn btn-primary btn-sm" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // إنشاء تقييم النجوم
        function generateStarRating(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }

        // الحصول على أيقونة التصنيف
        function getCategoryIcon(category) {
            const icons = {
                books: '<i class="fas fa-book"></i>',
                stationery: '<i class="fas fa-pencil-alt"></i>',
                bags: '<i class="fas fa-shopping-bag"></i>',
                gifts: '<i class="fas fa-gift"></i>'
            };
            return icons[category] || '<i class="fas fa-box"></i>';
        }

        // الحصول على اسم التصنيف
        function getCategoryName(category) {
            const names = {
                books: 'الكتب الدراسية',
                stationery: 'المستلزمات المكتبية',
                bags: 'الحقائب المدرسية',
                gifts: 'الهدايا'
            };
            return names[category] || category;
        }

        // إظهار نموذج إضافة منتج
        function showProductForm() {
            document.getElementById('productForm').classList.remove('hidden');
            document.getElementById('formTitle').textContent = 'إضافة منتج جديد';
            document.getElementById('productId').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productDiscount').value = '0';
            document.getElementById('productCategory').value = 'books';
            document.getElementById('productDescription').value = '';
            document.getElementById('productRating').value = '4';
            document.getElementById('productBadge').value = '';
            document.getElementById('productImageData').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImage').src = '';
        }

        // إخفاء نموذج المنتج
        function hideProductForm() {
            document.getElementById('productForm').classList.add('hidden');
        }

        // معالجة رفع الصورة
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('حجم الصورة كبير جداً. الحد الأقصى 5MB', 'error');
                    event.target.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('productImageData').value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // إزالة الصورة
        function removeImage() {
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('productImageData').value = '';
        }

        // حفظ المنتج
        function saveProduct() {
            const id = document.getElementById('productId').value;
            const name = sanitizeInput(document.getElementById('productName').value);
            const price = parseFloat(document.getElementById('productPrice').value);
            const discount = parseFloat(document.getElementById('productDiscount').value);
            const category = document.getElementById('productCategory').value;
            const description = sanitizeInput(document.getElementById('productDescription').value);
            const rating = parseFloat(document.getElementById('productRating').value);
            const badge = sanitizeInput(document.getElementById('productBadge').value);
            const imageData = document.getElementById('productImageData').value;

            if (!name || !price || !description || !category || !rating) {
                showNotification('يرجى ملء جميع الحقول الإلزامية', 'error');
                return;
            }

            const productData = {
                name,
                price,
                discount,
                category,
                description,
                rating,
                badge: badge || null
            };

            let uploadTask;
            if (imageData) {
                const imageName = `products/${Date.now()}_${name.replace(/\s+/g, '_')}.jpg`;
                uploadTask = storage.ref(imageName).putString(imageData.split(',')[1], 'base64', { contentType: 'image/jpeg' });
                
                uploadTask.on('state_changed', null, (error) => {
                    console.error('Error uploading image:', error);
                    showNotification('حدث خطأ في رفع الصورة', 'error');
                }, async () => {
                    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                    productData.imageUrl = downloadURL;
                    saveToFirestore(id, productData);
                });
            } else {
                saveToFirestore(id, productData);
            }
        }

        // حفظ في Firestore
        function saveToFirestore(id, productData) {
            if (id) {
                // تحديث
                db.collection('products').doc(id).update(productData)
                    .then(() => {
                        showNotification('تم تحديث المنتج بنجاح', 'success');
                        hideProductForm();
                    })
                    .catch((error) => {
                        console.error('Error updating product: ', error);
                        showNotification('حدث خطأ في تحديث المنتج', 'error');
                    });
            } else {
                // إضافة جديد
                db.collection('products').add(productData)
                    .then(() => {
                        showNotification('تم إضافة المنتج بنجاح', 'success');
                        hideProductForm();
                    })
                    .catch((error) => {
                        console.error('Error adding product: ', error);
                        showNotification('حدث خطأ في إضافة المنتج', 'error');
                    });
            }
        }

        // تعديل المنتج
        function editProduct(id) {
            db.collection('products').doc(id).get().then((doc) => {
                if (doc.exists) {
                    const product = doc.data();
                    showProductForm();
                    document.getElementById('formTitle').textContent = 'تعديل المنتج';
                    document.getElementById('productId').value = id;
                    document.getElementById('productName').value = product.name || '';
                    document.getElementById('productPrice').value = product.price || '';
                    document.getElementById('productDiscount').value = product.discount || '0';
                    document.getElementById('productCategory').value = product.category || 'books';
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productRating').value = product.rating || '4';
                    document.getElementById('productBadge').value = product.badge || '';
                    if (product.imageUrl) {
                        document.getElementById('previewImage').src = product.imageUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                        document.getElementById('productImageData').value = product.imageUrl;
                    }
                }
            });
        }

        // حذف المنتج
        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                db.collection('products').doc(id).delete()
                    .then(() => {
                        showNotification('تم حذف المنتج بنجاح', 'success');
                    })
                    .catch((error) => {
                        console.error('Error deleting product: ', error);
                        showNotification('حدث خطأ في حذف المنتج', 'error');
                    });
            }
        }

        // تصفية المنتجات حسب البحث
        function filterProducts() {
            currentSearchTerm = document.getElementById('searchInput').value;
            const products = []; // للحصول على المنتجات الحالية، لكن بما أنها realtime، يمكن إعادة التحميل أو تخزين مؤقت
            // للبساطة، نعيد تحميل المنتجات
            db.collection('products').get().then((snapshot) => {
                const products = [];
                snapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProducts(products);
            });
        }

        // مسح البحث
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearchTerm = '';
            db.collection('products').get().then((snapshot) => {
                const products = [];
                snapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProducts(products);
            });
        }

        // تعيين فلتر التصنيف
        function setCategoryFilter(category) {
            currentCategoryFilter = category;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            db.collection('products').get().then((snapshot) => {
                const products = [];
                snapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProducts(products);
            });
        }

        // إظهار الإشعار
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            messageEl.textContent = message;
            notification.className = `notification notification-${type} show`;
            setTimeout(hideNotification, 5000);
        }

        // إخفاء الإشعار
        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        // إظهار نافذة الكود
        function showCodeModal() {
            document.getElementById('codeModal').classList.add('active');
            generateCode();
        }

        // إخفاء نافذة الكود
        function hideCodeModal() {
            document.getElementById('codeModal').classList.remove('active');
        }

        // تبديل تبويبات الكود
        function switchCodeTab(tabName) {
            document.querySelectorAll('.code-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.code-section').forEach(section => section.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // نسخ الكود
        function copyCode(elementId, button) {
            const content = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(content).then(() => {
                button.classList.add('copied');
                setTimeout(() => button.classList.remove('copied'), 2000);
                showNotification('تم نسخ الكود بنجاح', 'success');
            }).catch(() => {
                showNotification('حدث خطأ في النسخ', 'error');
            });
        }

        // توليد الكود
        function generateCode() {
            db.collection('products').get().then((snapshot) => {
                let products = [];
                snapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });

                // كود JavaScript
                const jsCode = `// بيانات المنتجات
const products = ${JSON.stringify(products, null, 2)};

// دالة لعرض المنتجات
function renderProducts() {
    const container = document.getElementById('products-container');
    container.innerHTML = products.map(product => \`
        <div class="product">
            <h3>\${product.name}</h3>
            <p>\${product.description}</p>
            <p>السعر: \${product.price} جنيه</p>
            \${product.discount > 0 ? '<p>خصم: ' + product.discount + '%</p>' : ''}
        </div>
    \`).join('');
}

// استدعاء الدالة
renderProducts();`;

                document.getElementById('jsCodeContent').textContent = jsCode;

                // كود HTML
                const htmlCode = `<!DOCTYPE html>
<html>
<head>
    <title>متجر الرواد</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="products-container">
        <!-- المنتجات ستظهر هنا -->
    </div>
    <script>
        // أدرج كود JavaScript هنا
        ${jsCode.replace(/<\/script>/g, '<\\/script>')}
    </script>
</body>
</html>`;

                document.getElementById('htmlCodeContent').textContent = htmlCode;
            });
        }

        // إضافة منتجات نموذجية
        function addSampleProducts() {
            if (confirm('هل تريد إضافة منتجات نموذجية؟ سيتم إضافة 5 منتجات.')) {
                const samples = [
                    { name: 'كتاب الرياضيات', price: 50, discount: 10, category: 'books', description: 'كتاب دراسي للرياضيات', rating: 4.5, badge: 'جديد' },
                    { name: 'دفتر مذكرات', price: 15, discount: 0, category: 'stationery', description: 'دفتر عالي الجودة', rating: 4.0 },
                    { name: 'حقيبة مدرسية', price: 200, discount: 20, category: 'bags', description: 'حقيبة مدرسية متينة', rating: 4.8, badge: 'أكثر مبيعاً' },
                    { name: 'قلم حبر', price: 25, discount: 5, category: 'stationery', description: 'قلم حبر أسود', rating: 3.5 },
                    { name: 'هدية عيد ميلاد', price: 100, discount: 15, category: 'gifts', description: 'هدية مميزة', rating: 4.2 }
                ];

                samples.forEach(sample => {
                    db.collection('products').add(sample);
                });

                showNotification('تم إضافة المنتجات النموذجية', 'success');
            }
        }

        // حذف جميع المنتجات
        function clearAllProducts() {
            if (confirm('هل أنت متأكد من حذف جميع المنتجات؟ هذا الإجراء غير قابل للتراجع.')) {
                db.collection('products').get().then((snapshot) => {
                    const batch = db.batch();
                    snapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    batch.commit().then(() => {
                        showNotification('تم حذف جميع المنتجات', 'success');
                    });
                });
            }
        }

        // مزامنة مع الصفحة الرئيسية (مثال بسيط)
        function syncWithMainPage() {
            showNotification('تمت المزامنة مع الصفحة الرئيسية بنجاح', 'success');
            // يمكن إضافة منطق حقيقي هنا
        }

        // تصدير المنتجات
        function exportProducts() {
            db.collection('products').get().then((snapshot) => {
                let products = [];
                snapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                const dataStr = JSON.stringify(products, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'products.json';
                link.click();
            });
        }
    </script>
</body>
</html>
