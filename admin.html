<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المنتجات - مكتبة الرواد</title>
    
   <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
      import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBLAq1eYQ67zKLGs2my5_paM3GByrfPwYU",
        authDomain: "rawad-library.firebaseapp.com",
        projectId: "rawad-library",
        storageBucket: "rawad-library.firebasestorage.app",
        messagingSenderId: "981528745525",
        appId: "1:981528745525:web:5dd0c7c2d5b9d382d2437c",
        measurementId: "G-BCXJD0G7TK"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);
      
      // expose a minimal set (avoid polluting window too much)
      window._RL = window._RL || {};
      Object.assign(window._RL, { auth, db, storage, signInWithEmailAndPassword, signOut, onAuthStateChanged, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, ref, uploadBytes, getDownloadURL, deleteObject });
    </script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #1e3d59; --primary-light: #2a5a87; --secondary-color: #ff6b35; --success-color: #28a745; --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8; --light-color: #f8f9fa; --dark-color: #343a40; --gray-color: #6c757d; --border-radius: 10px; --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); --transition: all 0.3s ease; }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
        body{background:linear-gradient(135deg,#f5f7fa 0%,#e4e8f0 100%);color:#333;line-height:1.6;min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        header{background:linear-gradient(135deg,var(--primary-color),var(--primary-light));color:#fff;padding:1.5rem;border-radius:var(--border-radius);margin-bottom:2rem;text-align:center;box-shadow:var(--box-shadow);position:relative;overflow:hidden}
        h1{font-size:2.2rem;margin-bottom:.5rem}
        .admin-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
        .btn{padding:1rem 1.5rem;border:none;border-radius:var(--border-radius);cursor:pointer;font-weight:600;transition:var(--transition);display:inline-flex;align-items:center;gap:.5rem}
        .btn-primary{background:linear-gradient(135deg,var(--primary-color),var(--primary-light));color:#fff}
        .btn-success{background:linear-gradient(135deg,var(--success-color),#34ce57);color:#fff}
        .btn-danger{background:linear-gradient(135deg,var(--danger-color),#e74c3c);color:#fff}
        .btn-warning{background:linear-gradient(135deg,var(--warning-color),#ffd761);color:var(--dark-color)}
        .btn-info{background:linear-gradient(135deg,var(--info-color),#5bc0de);color:#fff}
        .btn-secondary{background:linear-gradient(135deg,#6c757d,#8a939b);color:#fff}
        .form-container, .products-section{background:#fff;padding:2rem;border-radius:var(--border-radius);box-shadow:var(--box-shadow);margin-bottom:2rem}
        label{display:block;margin-bottom:.5rem;font-weight:600;color:var(--primary-color)}
        input,select,textarea{width:100%;padding:.9rem;border:1px solid #ddd;border-radius:var(--border-radius);font-size:1rem}
        .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem}
        .product-card{background:#fff;border-radius:var(--border-radius);overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:var(--transition);border:1px solid #eee}
        .product-image{height:200px;background:linear-gradient(135deg,#f0f4f8 0%,#d9e1eb 100%);display:flex;align-items:center;justify-content:center;color:#a0aec0;font-size:2.5rem;position:relative;overflow:hidden}
        .product-image img{width:100%;height:100%;object-fit:cover}
        .product-info{padding:1.5rem}
        .product-title{font-size:1.2rem;font-weight:700;margin-bottom:.5rem;color:var(--primary-color)}
        .product-price{font-size:1.2rem;font-weight:700;color:#28a745;margin-bottom:.5rem}
        .product-badge{position:absolute;top:15px;left:15px;background:var(--secondary-color);color:#fff;padding:.3rem .8rem;border-radius:20px;font-size:.8rem}
        .notification{position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:var(--border-radius);box-shadow:var(--box-shadow);z-index:1000;transform:translateX(100%);transition:var(--transition);display:flex;align-items:center;gap:.5rem;max-width:350px}
        .notification.show{transform:translateX(0)}
        .notification .msg{flex:1}
        .hidden{display:none}
        .code-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:2000;padding:20px;backdrop-filter:blur(5px);opacity:0;visibility:hidden;transition:var(--transition)}
        .code-modal.active{opacity:1;visibility:visible}
        .code-content{background:#fff;padding:2rem;border-radius:var(--border-radius);width:90%;max-width:900px;max-height:80vh;overflow-y:auto}
        .code-body{background:#f8f9fa;padding:1.5rem;border-radius:var(--border-radius);overflow-x:auto;font-family:'Courier New',monospace;white-space:pre-wrap;max-height:400px}
        .filter-btn.active{background:var(--primary-color);color:#fff}
        @media(max-width:768px){.admin-actions{grid-template-columns:1fr}.products-grid{grid-template-columns:1fr}}
        [dir="rtl"] .fa{transform:scaleX(-1)}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>نظام إدارة المنتجات - مكتبة الرواد</h1>
            <p class="header-subtitle">إضافة وتعديل المنتجات المعروضة في المتجر</p>
        </header>

        <div class="admin-actions" id="adminActions">
            <button class="btn btn-primary" data-action="addProduct"><i class="fas fa-plus"></i> إضافة منتج جديد</button>
            <button class="btn btn-success" data-action="sync"><i class="fas fa-sync"></i> مزامنة مع الصفحة الرئيسية</button>
            <button class="btn btn-info" data-action="showCode"><i class="fas fa-code"></i> نسخ أكواد المنتجات</button>
            <button class="btn btn-warning" data-action="addSample"><i class="fas fa-download"></i> إضافة منتجات نموذجية</button>
            <button class="btn btn-danger" data-action="clearAll"><i class="fas fa-trash"></i> حذف جميع المنتجات</button>
            <button class="btn btn-secondary" data-action="export"><i class="fas fa-file-export"></i> تصدير المنتجات</button>
            <button class="btn btn-secondary" data-action="gotoHome"><i class="fas fa-home"></i> العودة للمتجر</button>
        </div>

        <div class="form-container hidden" id="productForm">
            <h2 class="form-title" id="formTitle">إضافة منتج جديد</h2>
            <div class="form-group">
                <label for="productName">اسم المنتج</label>
                <input type="text" id="productName" required placeholder="أدخل اسم المنتج">
            </div>
            <div class="form-group">
                <label for="productPrice">السعر الأصلي (جنيه)</label>
                <input type="number" id="productPrice" min="0" required placeholder="أدخل السعر الأصلي">
            </div>
            <div class="form-group">
                <label for="productDiscount">نسبة الخصم (%)</label>
                <input type="number" id="productDiscount" min="0" max="100" value="0" placeholder="أدخل نسبة الخصم">
            </div>
            <div class="form-group">
                <label for="productCategory">التصنيف</label>
                <select id="productCategory" required>
                    <option value="books">الكتب الدراسية</option>
                    <option value="stationery">المستلزمات المكتبية</option>
                    <option value="bags">الحقائب المدرسية</option>
                    <option value="gifts">الهدايا</option>
                </select>
            </div>
            <div class="form-group">
                <label for="productDescription">الوصف</label>
                <textarea id="productDescription" required placeholder="أدخل وصف المنتج"></textarea>
            </div>
            <div class="form-group">
                <label for="productRating">التقييم (من 5)</label>
                <input type="number" id="productRating" min="1" max="5" value="4" required>
            </div>
            <div class="form-group">
                <label for="productBadge">علامة مميزة (اختياري)</label>
                <input type="text" id="productBadge" placeholder="جديد، الأكثر مبيعاً، إلخ...">
            </div>
            <div class="form-group">
                <label>صورة المنتج</label>
                <div class="image-upload-container">
                    <label for="productImage" class="image-upload-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        انقر لرفع صورة المنتج
                        <input type="file" id="productImage" accept="image/*" style="display:none">
                    </label>
                    <p class="image-size-warning">الحجم الأقصى للصورة: 5MB، الأبعاد: 2000x2000 بكسل</p>
                    <div class="image-preview" id="imagePreview" style="display:none;position:relative">
                        <img id="previewImage" src="" alt="معاينة الصورة">
                        <button type="button" class="remove-image-btn" id="removeImageBtn" title="إزالة الصورة"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            </div>
            <input type="hidden" id="productId">
            <input type="hidden" id="productImageData">
            <div class="form-actions">
                <button class="btn btn-success" id="saveProductBtn"><i class="fas fa-save"></i> حفظ المنتج</button>
                <button class="btn btn-danger" id="cancelProductBtn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>

        <div class="products-section">
            <h2 class="section-title">المنتجات الحالية</h2>
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="ابحث عن منتج...">
                <button class="btn btn-info" id="clearSearchBtn"><i class="fas fa-times"></i> مسح البحث</button>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">الكل</button>
                <button class="filter-btn" data-filter="books">الكتب الدراسية</button>
                <button class="filter-btn" data-filter="stationery">المستلزمات المكتبية</button>
                <button class="filter-btn" data-filter="bags">الحقائب المدرسية</button>
                <button class="filter-btn" data-filter="gifts">الهدايا</button>
            </div>
            <div class="products-grid" id="productsList"></div>
        </div>

        <div class="footer">
            <p>© 2025 نظام إدارة المنتجات - مكتبة الرواد. جميع الحقوق محفوظة.</p>
            <p>تم التطوير بواسطة فريق الثقيلة المتخصص</p>
            <p><a href="#" style="color:var(--primary-color);text-decoration:none;">سياسة الخصوصية</a> | <a href="#" style="color:var(--primary-color);text-decoration:none;">شروط الخدمة</a></p>
        </div>
    </div>

    <div class="notification" id="notification" aria-live="polite" role="status" style="display:none">
        <i class="fas fa-check-circle" id="notificationIcon"></i>
        <div class="msg" id="notificationMessage"></div>
        <button class="close-btn" id="notificationCloseBtn" aria-label="إغلاق الإشعار"><i class="fas fa-times"></i></button>
    </div>

    <div class="code-modal" id="codeModal" aria-hidden="true">
        <div class="code-content" role="dialog" aria-labelledby="codeTitle">
            <div class="code-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;border-bottom:1px solid #eee;padding-bottom:1rem">
                <h2 id="codeTitle">أكواد المنتجات</h2>
                <button class="close-btn" id="closeCodeModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="code-tabs" style="display:flex;gap:.5rem;margin-bottom:1rem">
                <button class="code-tab active" data-tab="jsCode">كود JavaScript</button>
                <button class="code-tab" data-tab="htmlCode">كود HTML للصفحة</button>
            </div>
            <div class="code-section active" id="jsCode">
                <div class="code-body" id="jsCodeContent"></div>
                <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem">
                    <button class="btn btn-info" id="copyJsBtn"><i class="fas fa-copy"></i> نسخ كود JavaScript</button>
                </div>
            </div>
            <div class="code-section" id="htmlCode">
                <div class="code-body" id="htmlCodeContent"></div>
                <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.75rem">
                    <button class="btn btn-info" id="copyHtmlBtn"><i class="fas fa-copy"></i> نسخ كود HTML</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // -----------------------
        // بيانات وعينات
        // -----------------------
        let currentCategoryFilter = 'all';
        let currentSearchTerm = '';

        const sampleProducts = [
                {
                    id: 1,
                    name: 'قاموس المعاصر - نسخة مدرسية',
                    price: 120.00,
                    discount: 10,
                    category: 'books',
                    description: 'قاموس مبسط ومحدث يضم مفردات اللغة العربية مع أمثلة واختصارات مناسبة للطلاب.',
                    rating: 5,
                    badge: 'الأكثر مبيعاً',
                    image: ''
                },
                {
                    id: 2,
                    name: 'دفتر ملاحظات A4 (50 ورقة)',
                    price: 25.50,
                    discount: 0,
                    category: 'stationery',
                    description: 'دفتر سميك عالي الجودة مع غلاف مقاوم للماء، مناسب للمدرسة والجامعة.',
                    rating: 4,
                    badge: '',
                    image: ''
                },
                {
                    id: 3,
                    name: 'حقيبة مدرسية ضد الماء',
                    price: 299.99,
                    discount: 15,
                    category: 'bags',
                    description: 'حقيبة ظهر مريحة مع دعم للظهر ومقصورات متعددة لحفظ اللابتوب والكتب.',
                    rating: 5,
                    badge: 'جديد',
                    image: ''
                },
                {
                    id: 4,
                    name: 'مجموعة أقلام تلوين 24 لون',
                    price: 75.00,
                    discount: 5,
                    category: 'stationery',
                    description: 'ألوان ساطعة وثابتة مع فرشاة ومرطبان مخمل لحفظ الألوان.',
                    rating: 4,
                    badge: '',
                    image: ''
                },
                {
                    id: 5,
                    name: 'كتاب الرياضيات للصف الثالث الثانوي',
                    price: 200.00,
                    discount: 20,
                    category: 'books',
                    description: 'منهج كامل مع أمثلة محلولة وأسئلة امتحانية شاملة.',
                    rating: 5,
                    badge: 'خصم خاص',
                    image: ''
                },
                {
                    id: 6,
                    name: 'هدية تذكارية - محفظة جلدية',
                    price: 149.00,
                    discount: 0,
                    category: 'gifts',
                    description: 'محفظة جلدية أنيقة هدية مثالية للمناسبات.',
                    rating: 4,
                    badge: '',
                    image: ''
                }
            ];

        // -----------------------
        // تعقيم المدخلات - escape بدل إزالة
        // -----------------------
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
        }

        // -----------------------
        // مساعدة عرض الأيقونات والتصنيفات
        // -----------------------
        function getCategoryIcon(category) {
            const icons = {
                'books': '<i class="fas fa-book" aria-hidden="true" style="font-size:2.5rem;color:#1e3d59"></i>',
                'stationery': '<i class="fas fa-pen" aria-hidden="true" style="font-size:2.5rem;color:#ff6b35"></i>',
                'bags': '<i class="fas fa-briefcase" aria-hidden="true" style="font-size:2.5rem;color:#28a745"></i>',
                'gifts': '<i class="fas fa-gift" aria-hidden="true" style="font-size:2.5rem;color:#ffc107"></i>'
            };
            return icons[category] || '<i class="fas fa-box" aria-hidden="true" style="font-size:2.5rem;color:#a0aec0"></i>';
        }

        function getCategoryName(category) {
            const names = { 'books':'الكتب الدراسية','stationery':'المستلزمات المكتبية','bags':'الحقائب المدرسية','gifts':'الهدايا' };
            return names[category] || category;
        }

        // -----------------------
        // إشعارات آمنة
        // -----------------------
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const msg = document.getElementById('notificationMessage');
            const icon = document.getElementById('notificationIcon');
            const closeBtn = document.getElementById('notificationCloseBtn');

            msg.textContent = message;
            notification.className = 'notification show notification-' + type;
            notification.style.display = 'flex';

            icon.className = 'fas ' + (type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle');

            // auto hide
            clearTimeout(notification._hideTimer);
            notification._hideTimer = setTimeout(() => {
                hideNotification();
            }, 4500);

            closeBtn.onclick = hideNotification;
        }

        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.style.display = 'none';
            notification.classList.remove('show');
        }

        // -----------------------
        // إدارة المنتجات (localStorage)
        // -----------------------
        function addSampleProducts() {
            // keep original sample data safe: populate only if empty
            const existing = JSON.parse(localStorage.getItem('rawad-products')) || [];
            if (existing.length === 0) {
                // (for brevity the sample data is omitted here; in the real file include the array)
                localStorage.setItem('rawad-products', JSON.stringify(sampleProducts));
                showNotification('تم إضافة منتجات نموذجية');
                loadProducts();
            } else {
                showNotification('هناك منتجات بالفعل', 'info');
            }
        }

        function loadProducts() {
            const productsList = document.getElementById('productsList');
            const products = JSON.parse(localStorage.getItem('rawad-products')) || [];

            const filteredProducts = products.filter(product => {
                const matchesCategory = currentCategoryFilter === 'all' || product.category === currentCategoryFilter;
                const term = currentSearchTerm.trim().toLowerCase();
                const matchesSearch = !term || product.name.toLowerCase().includes(term) || product.description.toLowerCase().includes(term);
                return matchesCategory && matchesSearch;
            });

            if (filteredProducts.length === 0) {
                productsList.innerHTML = `<div class="empty-state"><i class="fas fa-box-open" aria-hidden="true"></i><h3>لا توجد منتجات حالياً</h3><p>لم يتم إضافة أي منتجات بعد.</p><button class="btn btn-primary" data-action="addProduct"><i class="fas fa-plus"></i> إضافة منتج جديد</button></div>`;
                // re-bind added button
                const btn = productsList.querySelector('[data-action="addProduct"]');
                if (btn) btn.addEventListener('click', showProductForm);
                return;
            }

            productsList.innerHTML = filteredProducts.map(product => {
                const finalPrice = product.discount > 0 ? product.price - (product.price * product.discount / 100) : product.price;
                return `
                <div class="product-card" data-id="${product.id}" data-category="${product.category}">
                    ${product.badge ? `<span class="product-badge">${sanitizeInput(product.badge)}</span>` : ''}
                    <div class="product-image">${product.image ? `<img src="${sanitizeInput(product.image)}" alt="${sanitizeInput(product.name)}">` : getCategoryIcon(product.category)}</div>
                    <div class="product-info">
                        <h3 class="product-title">${sanitizeInput(product.name)}</h3>
                        <div class="product-price">
                            ${product.discount > 0 ? `<span class="discount-badge">خصم ${product.discount}%</span><span class="original-price">${product.price.toFixed(2)} جنيه</span>` : ''}
                            ${finalPrice.toFixed(2)} جنيه
                        </div>
                        <span class="product-category">${getCategoryName(product.category)}</span>
                        <div class="product-rating">${'★'.repeat(product.rating)}${'☆'.repeat(5-product.rating)} <span>(${product.rating}.0)</span></div>
                        <p class="product-description">${sanitizeInput(product.description)}</p>
                        <div class="product-actions">
                            <button class="btn btn-primary btn-sm" data-action="edit" data-id="${product.id}"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="btn btn-danger btn-sm" data-action="delete" data-id="${product.id}"><i class="fas fa-trash"></i> حذف</button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            // bind action buttons
            productsList.querySelectorAll('[data-action="edit"]').forEach(btn => btn.addEventListener('click', e => editProduct(parseInt(e.currentTarget.dataset.id))));
            productsList.querySelectorAll('[data-action="delete"]').forEach(btn => btn.addEventListener('click', e => deleteProduct(parseInt(e.currentTarget.dataset.id))));
        }

        function saveProduct() {
            const productId = document.getElementById('productId').value;
            const name = sanitizeInput(document.getElementById('productName').value.trim());
            const price = parseFloat(document.getElementById('productPrice').value);
            const discount = parseInt(document.getElementById('productDiscount').value) || 0;
            const category = document.getElementById('productCategory').value;
            const description = sanitizeInput(document.getElementById('productDescription').value.trim());
            const rating = parseInt(document.getElementById('productRating').value);
            const badge = sanitizeInput(document.getElementById('productBadge').value.trim());
            const imageData = document.getElementById('productImageData').value;

            if (!name || isNaN(price) || !category || !description || !rating) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            if (price < 0) { showNotification('السعر لا يمكن أن يكون سالباً', 'error'); return; }
            if (rating < 1 || rating > 5) { showNotification('التقييم يجب أن يكون بين 1 و5', 'error'); return; }

            let products = JSON.parse(localStorage.getItem('rawad-products')) || [];
            const existingProduct = products.find(p => p.name === name && p.id != productId);
            if (existingProduct) { showNotification('اسم المنتج موجود بالفعل', 'error'); return; }

            if (productId) {
                const index = products.findIndex(p => p.id == productId);
                if (index !== -1) {
                    products[index] = Object.assign({}, products[index], { name, price, discount, category, description, rating, badge, image: imageData || products[index].image || '' });
                    showNotification('تم تعديل المنتج بنجاح');
                }
            } else {
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({ id: newId, name, price, discount, category, description, rating, badge, image: imageData || '' });
                showNotification('تم إضافة المنتج بنجاح');
            }
            localStorage.setItem('rawad-products', JSON.stringify(products));
            hideProductForm();
            loadProducts();
        }

        function editProduct(id) {
            const products = JSON.parse(localStorage.getItem('rawad-products')) || [];
            const product = products.find(p => p.id === id);
            if (!product) return showNotification('المنتج غير موجود', 'error');
            document.getElementById('productForm').classList.remove('hidden');
            document.getElementById('formTitle').textContent = 'تعديل المنتج';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productDiscount').value = product.discount || 0;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productRating').value = product.rating;
            document.getElementById('productBadge').value = product.badge || '';
            document.getElementById('productImageData').value = product.image || '';
            if (product.image) { document.getElementById('previewImage').src = product.image; document.getElementById('imagePreview').style.display = 'block'; }
            else { document.getElementById('imagePreview').style.display = 'none'; }
        }

        function deleteProduct(id) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
            let products = JSON.parse(localStorage.getItem('rawad-products')) || [];
            products = products.filter(p => p.id !== id);
            localStorage.setItem('rawad-products', JSON.stringify(products));
            showNotification('تم حذف المنتج بنجاح');
            loadProducts();
        }

        function clearAllProducts() {
            if (!confirm('هل أنت متأكد من حذف جميع المنتجات؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            localStorage.removeItem('rawad-products');
            showNotification('تم حذف جميع المنتجات');
            loadProducts();
        }

        function exportProducts() {
            const products = JSON.parse(localStorage.getItem('rawad-products')) || [];
            if (products.length === 0) return showNotification('لا توجد منتجات لتصديرها', 'error');
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(products));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute('href', dataStr);
            downloadAnchor.setAttribute('download', 'products.json');
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            document.body.removeChild(downloadAnchor);
            showNotification('تم تصدير المنتجات بنجاح');
        }

        // -----------------------
        // صورة الرفع
        // -----------------------
        document.getElementById('productImage').addEventListener('change', function(e){
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { showNotification('حجم الصورة يجب أن يكون أقل من 5MB', 'error'); e.target.value = ''; return; }
            if (!file.type.match('image.*')) { showNotification('يرجى اختيار ملف صورة فقط', 'error'); e.target.value = ''; return; }
            const img = new Image();
            img.onload = function(){ if (img.width > 2000 || img.height > 2000) { showNotification('أبعاد الصورة كبيرة جدًا، يرجى اختيار صورة أصغر', 'error'); e.target.value = ''; return; } const reader=new FileReader(); reader.onload=function(ev){ document.getElementById('productImageData').value = ev.target.result; document.getElementById('previewImage').src = ev.target.result; document.getElementById('imagePreview').style.display = 'block'; }; reader.readAsDataURL(file); };
            img.src = URL.createObjectURL(file);
        });

        document.getElementById('removeImageBtn').addEventListener('click', function(){ document.getElementById('productImageData').value=''; document.getElementById('previewImage').src=''; document.getElementById('imagePreview').style.display='none'; document.getElementById('productImage').value=''; });

        // -----------------------
        // البحث والفلترة
        // -----------------------
        document.getElementById('searchInput').addEventListener('input', function(e){ currentSearchTerm = e.target.value; loadProducts(); });
        document.getElementById('clearSearchBtn').addEventListener('click', function(){ document.getElementById('searchInput').value=''; currentSearchTerm=''; loadProducts(); });

        document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', function(){ currentCategoryFilter = this.dataset.filter; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active'); loadProducts(); }));

        // -----------------------
        // ربط أزرار الإدارة (بدون inline handlers)
        // -----------------------
        document.getElementById('adminActions').addEventListener('click', function(e){ const action = e.target.closest('[data-action]')?.dataset.action; if(!action) return; switch(action){ case 'addProduct': showProductForm(); break; case 'sync': showNotification('تمت المزامنة بنجاح مع الصفحة الرئيسية'); break; case 'showCode': showCodeModal(); break; case 'addSample': addSampleProducts(); break; case 'clearAll': clearAllProducts(); break; case 'export': exportProducts(); break; case 'gotoHome': window.location.href='index.html'; break; } });

        // form buttons
        document.getElementById('saveProductBtn').addEventListener('click', function(e){ e.preventDefault(); saveProduct(); });
        document.getElementById('cancelProductBtn').addEventListener('click', function(e){ e.preventDefault(); hideProductForm(); });

        // -----------------------
        // نافذة الأكواد
        // -----------------------
        document.getElementById('closeCodeModal').addEventListener('click', hideCodeModal);
        document.getElementById('copyJsBtn').addEventListener('click', function(){ copyCodeText('jsCodeContent'); });
        document.getElementById('copyHtmlBtn').addEventListener('click', function(){ copyCodeText('htmlCodeContent'); });
        document.querySelectorAll('.code-tab').forEach(tab => tab.addEventListener('click', function(){ document.querySelectorAll('.code-tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.code-section').forEach(s=>s.classList.remove('active')); tab.classList.add('active'); const id = tab.dataset.tab==='jsCode' ? 'jsCode' : 'htmlCode'; document.getElementById(id).classList.add('active'); }));

        function showCodeModal(){ const products = JSON.parse(localStorage.getItem('rawad-products')) || []; if(products.length===0){ showNotification('لا توجد منتجات لإنشاء أكواد لها','error'); return; } document.getElementById('jsCodeContent').textContent = generateJSCodeForExport(products); document.getElementById('htmlCodeContent').textContent = generateHTMLCodeForExport(products); document.getElementById('codeModal').classList.add('active'); document.getElementById('codeModal').setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
        function hideCodeModal(){ document.getElementById('codeModal').classList.remove('active'); document.getElementById('codeModal').setAttribute('aria-hidden','true'); document.body.style.overflow='auto'; }
        function copyCodeText(elId){ const text = document.getElementById(elId).textContent; if(navigator.clipboard && window.isSecureContext){ navigator.clipboard.writeText(text).then(()=> showNotification('تم نسخ الأكواد بنجاح')); } else { fallbackCopyText(text); } }
        function fallbackCopyText(text){ const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity=0; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); showNotification('تم النسخ'); }catch(e){ showNotification('فشل النسخ، انسخ يدوياً','error'); } document.body.removeChild(ta); }

        // namespaced generator to avoid collisions when pasted to other pages
        function generateJSCodeForExport(products){
            return `// RL_PRODUCTS_EXPORT\nconst RL_products = ${JSON.stringify(products, null, 4)};\n// يمكنك تعديل أو استخدام RL_products داخل صفحتك`;
        }
        function generateHTMLCodeForExport(products){
            // Simple HTML export (safe escaped)
            const escapedItems = products.map(p=>`<div class=\"product-card\">\n  <div class=\"product-title\">${sanitizeInput(p.name)}</div>\n</div>`).join('\n');
            return `<!-- RL_PRODUCTS_HTML -->\n<div class=\"products-grid\">\n${escapedItems}\n</div>`;
        }

        // -----------------------
        // small helpers
        // -----------------------
        function showProductForm(){ document.getElementById('productForm').classList.remove('hidden'); document.getElementById('formTitle').textContent='إضافة منتج جديد'; document.getElementById('productId').value=''; document.getElementById('productName').value=''; document.getElementById('productPrice').value=''; document.getElementById('productDiscount').value='0'; document.getElementById('productCategory').value='books'; document.getElementById('productDescription').value=''; document.getElementById('productRating').value='4'; document.getElementById('productBadge').value=''; document.getElementById('productImageData').value=''; document.getElementById('imagePreview').style.display='none'; document.getElementById('previewImage').src=''; }
        function hideProductForm(){ document.getElementById('productForm').classList.add('hidden'); }

        // -----------------------
        // init
        // -----------------------
        document.addEventListener('DOMContentLoaded', function(){ if(!localStorage.getItem('rawad-products')){ localStorage.setItem('rawad-products', JSON.stringify(sampleProducts)); } loadProducts(); document.addEventListener('keydown', function(e){ if(e.key==='Escape'){ hideCodeModal(); hideProductForm(); hideNotification(); } }); document.getElementById('productsList').addEventListener('click', function(e){ const actionBtn = e.target.closest('[data-action]'); if(actionBtn){ const action = actionBtn.dataset.action; const id = parseInt(actionBtn.dataset.id); if(action==='edit') editProduct(id); if(action==='delete') deleteProduct(id); } }); });

    </script>
</body>
</html>
