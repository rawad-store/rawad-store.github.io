<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - مكتبة الرواد</title>
    
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
      import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
      import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBLAq1eYQ67zKLGs2my5_paM3GByrfPwYU",
        authDomain: "rawad-library.firebaseapp.com",
        projectId: "rawad-library",
        storageBucket: "rawad-library.firebasestorage.app",
        messagingSenderId: "981528745525",
        appId: "1:981528745525:web:5dd0c7c2d5b9d382d2437c",
        measurementId: "G-BCXJD0G7TK"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);
      
      // جعل المتغيرات متاحة عالمياً
      window.auth = auth;
      window.db = db;
      window.storage = storage;
      window.signInWithEmailAndPassword = signInWithEmailAndPassword;
      window.signOut = signOut;
      window.onAuthStateChanged = onAuthStateChanged;
      window.collection = collection;
      window.addDoc = addDoc;
      window.getDocs = getDocs;
      window.doc = doc;
      window.updateDoc = updateDoc;
      window.deleteDoc = deleteDoc;
      window.query = query;
      window.orderBy = orderBy;
      window.where = where;
      window.ref = ref;
      window.uploadBytes = uploadBytes;
      window.getDownloadURL = getDownloadURL;
      window.deleteObject = deleteObject;
    </script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #1e3d59;
            --secondary-color: #ff6b35;
            --accent-color: #f7931e;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --white-color: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            direction: rtl;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Form */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="login-gradient"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="transparent"/></radialGradient></defs><circle cx="200" cy="200" r="300" fill="url(%23login-gradient)"/><circle cx="800" cy="800" r="400" fill="url(%23login-gradient)"/></svg>');
            opacity: 0.3;
        }

        .login-form {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            color: white;
            font-size: 2rem;
        }

        .login-title {
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: right;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 61, 89, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.9rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            border: none;
            border-radius: var(--border-radius);
            text-decoration: none;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #2a5a87);
            color: white;
            box-shadow: 0 4px 15px rgba(30, 61, 89, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 61, 89, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #34ce57);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #e85d75);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #ffda6a);
            color: var(--dark-color);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #5bc0de);
            color: white;
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Admin Dashboard */
        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #2a5a87);
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-logo-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .admin-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .admin-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Dashboard Content */
        .dashboard {
            padding: 2rem 0;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray-600);
            font-weight: 600;
        }

        /* Product Management */
        .section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-content {
            padding: 2rem;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
            font-weight: 600;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.9rem;
            border: 2px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 61, 89, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.9rem;
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius);
            background: var(--gray-100);
            transition: var(--transition);
            cursor: pointer;
        }

        .file-input-wrapper:hover .file-input-label {
            border-color: var(--primary-color);
            background: rgba(30, 61, 89, 0.05);
        }

        .image-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        /* Products Table */
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .products-table th,
        .products-table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid var(--gray-200);
        }

        .products-table th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
        }

        .products-table tr:hover {
            background: var(--gray-50);
        }

        .product-image-cell {
            width: 80px;
        }

        .product-image-cell img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--border-radius);
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
        }

        .filter-select {
            min-width: 150px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            transform: translateX(400px);
            transition: var(--transition);
            box-shadow: var(--shadow);
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.warning {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 2rem;
            max-height: 50vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-header .container {
                flex-direction: column;
                text-align: center;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .search-filter {
                flex-direction: column;
            }

            .products-table {
                font-size: 0.9rem;
            }

            .products-table th,
            .products-table td {
                padding: 0.5rem;
            }

            .product-actions {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 1rem;
                flex-direction: column;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .d-none { display: none; }
        .d-block { display: block; }
        .d-flex { display: flex; }
        .justify-center { justify-content: center; }
        .align-center { align-items: center; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .p-1 { padding: 0.5rem; }
        .p-2 { padding: 1rem; }
        .p-3 { padding: 1.5rem; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="spinner"></div>
        <p>جاري التحميل...</p>
    </div>

    <!-- Login Form -->
    <div id="loginContainer" class="login-container">
        <form class="login-form" id="loginForm">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
            </div>
            <h1 class="login-title">تسجيل الدخول</h1>
            <p style="color: var(--gray-600); margin-bottom: 2rem;">لوحة التحكم - مكتبة الرواد</p>
            
            <div class="form-group">
                <label class="form-label">البريد الإلكتروني</label>
                <input type="email" class="form-input" id="loginEmail" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">كلمة المرور</label>
                <input type="password" class="form-input" id="loginPassword" required>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i>
                تسجيل الدخول
            </button>
            
            <div id="loginError" class="mt-2" style="color: var(--danger-color); text-align: center; display: none;"></div>
        </form>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="d-none">
        <!-- Header -->
        <header class="admin-header">
            <div class="container">
                <div class="admin-logo">
                    <div class="admin-logo-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div>
                        <div class="admin-title">لوحة التحكم</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">مكتبة الرواد</div>
                    </div>
                </div>
                
                <div class="admin-actions">
                    <div class="user-info">
                        <i class="fas fa-user"></i>
                        <span id="userEmail"></span>
                    </div>
                    <a href="index.html" class="btn btn-info btn-sm" target="_blank">
                        <i class="fas fa-external-link-alt"></i>
                        عرض الموقع
                    </a>
                    <button class="btn btn-danger btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        تسجيل الخروج
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard Content -->
        <main class="dashboard">
            <div class="container">
                <!-- Statistics -->
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">إجمالي المنتجات</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-number" id="booksCount">0</div>
                        <div class="stat-label">الكتب الدراسية</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-pen"></i>
                        </div>
                        <div class="stat-number" id="stationeryCount">0</div>
                        <div class="stat-label">المستلزمات المكتبية</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-briefcase"></i>
                        </div>
                        <div class="stat-number" id="bagsCount">0</div>
                        <div class="stat-label">الحقائب المدرسية</div>
                    </div>
                </div>

                <!-- Add Product Section -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-plus"></i>
                            إضافة منتج جديد
                        </h2>
                    </div>
                    <div class="section-content">
                        <form id="productForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">اسم المنتج</label>
                                    <input type="text" class="form-input" id="productName" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">التصنيف</label>
                                    <select class="form-select" id="productCategory" required>
                                        <option value="">اختر التصنيف</option>
                                        <option value="books">الكتب الدراسية</option>
                                        <option value="stationery">المستلزمات المكتبية</option>
                                        <option value="bags">الحقائب المدرسية</option>
                                        <option value="gifts">الهدايا</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">السعر (جنيه)</label>
                                    <input type="number" class="form-input" id="productPrice" step="0.01" min="0" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">نسبة الخصم (%)</label>
                                    <input type="number" class="form-input" id="productDiscount" min="0" max="100" value="0">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">التقييم (1-5)</label>
                                    <select class="form-select" id="productRating">
                                        <option value="5">5 نجوم</option>
                                        <option value="4">4 نجوم</option>
                                        <option value="3">3 نجوم</option>
                                        <option value="2">2 نجوم</option>
                                        <option value="1">1 نجمة</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">شارة المنتج</label>
                                    <input type="text" class="form-input" id="productBadge">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">وصف المنتج</label>
                                <textarea class="form-textarea" id="productDescription" required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">صورة المنتج</label>
                                <div class="file-input-wrapper">
                                    <input type="file" class="file-input" id="productImage" accept="image/*">
                                    <div class="file-input-label">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        اختر صورة
                                    </div>
                                </div>
                                <div class="image-preview" id="imagePreview"></div>
                            </div>
                            
                            <div class="form-row">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus"></i>
                                    إضافة المنتج
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Products List Section -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-boxes"></i>
                            قائمة المنتجات
                        </h2>
                        <div class="section-actions">
                            <button class="btn btn-warning btn-sm" onclick="exportProducts()">
                                <i class="fas fa-file-export"></i>
                                تصدير إلى CSV
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="confirmClearAll()">
                                <i class="fas fa-trash-alt"></i>
                                حذف الكل
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="search-filter">
                            <input type="text" class="form-input search-input" id="searchProducts" placeholder="ابحث عن منتج...">
                            <select class="form-select filter-select" id="filterCategory">
                                <option value="">جميع التصنيفات</option>
                                <option value="books">الكتب الدراسية</option>
                                <option value="stationery">المستلزمات المكتبية</option>
                                <option value="bags">الحقائب المدرسية</option>
                                <option value="gifts">الهدايا</option>
                            </select>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table class="products-table">
                                <thead>
                                    <tr>
                                        <th>الصورة</th>
                                        <th>اسم المنتج</th>
                                        <th>التصنيف</th>
                                        <th>السعر</th>
                                        <th>الخصم</th>
                                        <th>التقييم</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- Products will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تعديل المنتج</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">اسم المنتج</label>
                            <input type="text" class="form-input" id="editProductName" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">التصنيف</label>
                            <select class="form-select" id="editProductCategory" required>
                                <option value="books">الكتب الدراسية</option>
                                <option value="stationery">المستلزمات المكتبية</option>
                                <option value="bags">الحقائب المدرسية</option>
                                <option value="gifts">الهدايا</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">السعر (جنيه)</label>
                            <input type="number" class="form-input" id="editProductPrice" step="0.01" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">نسبة الخصم (%)</label>
                            <input type="number" class="form-input" id="editProductDiscount" min="0" max="100">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">التقييم (1-5)</label>
                            <select class="form-select" id="editProductRating">
                                <option value="5">5 نجوم</option>
                                <option value="4">4 نجوم</option>
                                <option value="3">3 نجوم</option>
                                <option value="2">2 نجوم</option>
                                <option value="1">1 نجمة</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">شارة المنتج</label>
                            <input type="text" class="form-input" id="editProductBadge">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">وصف المنتج</label>
                        <textarea class="form-textarea" id="editProductDescription" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">صورة المنتج الجديدة (اختياري)</label>
                        <div class="file-input-wrapper">
                            <input type="file" class="file-input" id="editProductImage" accept="image/*">
                            <div class="file-input-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                اختر صورة جديدة
                            </div>
                        </div>
                        <div class="image-preview" id="editImagePreview"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="updateProduct()">
                    <i class="fas fa-save"></i>
                    حفظ التغييرات
                </button>
                <button class="btn btn-danger" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
<script>
// Global Variables
let currentUser = null;
let allProducts = [];
let filteredProducts = [];
let editingProductId = null;

// Category Names Mapping
const categoryNames = {
    'books': 'الكتب الدراسية',
    'stationery': 'المستلزمات المكتبية',
    'bags': 'الحقائب المدرسية',
    'gifts': 'الهدايا'
};

// Initialize App
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication state
    window.onAuthStateChanged(window.auth, (user) => {
        if (user) {
            currentUser = user;
            showDashboard();
            loadProducts();
        } else {
            showLogin();
        }
    });

    // Setup event listeners
    setupEventListeners();
});

function setupEventListeners() {
    // Login form
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    
    // Product form
    document.getElementById('productForm').addEventListener('submit', handleAddProduct);
    
    // Image preview
    document.getElementById('productImage').addEventListener('change', previewImage);
    document.getElementById('editProductImage').addEventListener('change', previewEditImage);
    
    // Search and filter
    document.getElementById('searchProducts').addEventListener('input', filterProducts);
    document.getElementById('filterCategory').addEventListener('change', filterProducts);
}

// Authentication Functions
async function handleLogin(e) {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    
    showLoading();
    
    try {
        await window.signInWithEmailAndPassword(window.auth, email, password);
        errorDiv.style.display = 'none';
        showNotification('تم تسجيل الدخول بنجاح', 'success');
    } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = getErrorMessage(error.code);
        errorDiv.style.display = 'block';
        showNotification('فشل في تسجيل الدخول', 'error');
    } finally {
        hideLoading();
    }
}

async function logout() {
    try {
        await window.signOut(window.auth);
        showNotification('تم تسجيل الخروج بنجاح', 'success');
    } catch (error) {
        console.error('Logout error:', error);
        showNotification('فشل في تسجيل الخروج', 'error');
    }
}

function getErrorMessage(errorCode) {
    switch (errorCode) {
        case 'auth/user-not-found':
            return 'المستخدم غير موجود';
        case 'auth/wrong-password':
            return 'كلمة المرور غير صحيحة';
        case 'auth/invalid-email':
            return 'البريد الإلكتروني غير صحيح';
        case 'auth/too-many-requests':
            return 'تم تجاوز عدد المحاولات المسموح';
        default:
            return 'حدث خطأ في تسجيل الدخول: ' + errorCode;
    }
}

// UI Functions
function showLogin() {
    document.getElementById('loginContainer').classList.remove('d-none');
    document.getElementById('adminDashboard').classList.add('d-none');
}

function showDashboard() {
    document.getElementById('loginContainer').classList.add('d-none');
    document.getElementById('adminDashboard').classList.remove('d-none');
    document.getElementById('userEmail').textContent = currentUser.email;
}

function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('d-none');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('d-none');
}

// Product Management Functions
async function handleAddProduct(e) {
    e.preventDefault();
    
    const formData = getFormData();
    if (!formData) return;
    
    showLoading();
    
    try {
        let imageUrl = '';
        
        // Upload image if selected
        const imageFile = document.getElementById('productImage').files[0];
        if (imageFile) {
            imageUrl = await uploadImage(imageFile);
        }
        
        // Add product to Firestore
        const productData = {
            ...formData,
            image: imageUrl,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        await window.addDoc(window.collection(window.db, "products"), productData);
        
        showNotification('تم إضافة المنتج بنجاح', 'success');
        resetForm();
        await loadProducts();
        
    } catch (error) {
        console.error('Error adding product:', error);
        showNotification('فشل في إضافة المنتج: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function getFormData() {
    const name = document.getElementById('productName').value.trim();
    const category = document.getElementById('productCategory').value;
    const price = parseFloat(document.getElementById('productPrice').value);
    const discount = parseInt(document.getElementById('productDiscount').value) || 0;
    const rating = parseInt(document.getElementById('productRating').value);
    const badge = document.getElementById('productBadge').value.trim();
    const description = document.getElementById('productDescription').value.trim();
    
    if (!name || !category || isNaN(price) || !description) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'warning');
        return null;
    }
    
    return {
        name,
        category,
        price,
        discount,
        rating,
        badge,
        description
    };
}

async function uploadImage(file) {
    const fileName = `products/${Date.now()}_${file.name}`;
    const storageRef = window.ref(window.storage, fileName);
    
    try {
        const snapshot = await window.uploadBytes(storageRef, file);
        const downloadURL = await window.getDownloadURL(snapshot.ref);
        return downloadURL;
    } catch (error) {
        console.error('Error uploading image:', error);
        throw new Error('فشل في رفع الصورة');
    }
}

async function loadProducts() {
    try {
        showLoading();
        const querySnapshot = await window.getDocs(window.query(
            window.collection(window.db, "products"),
            window.orderBy('createdAt', 'desc')
        ));
        allProducts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        filteredProducts = [...allProducts];
        
        displayProducts();
        updateStatistics();
        
    } catch (error) {
        console.error('Error loading products:', error);
        showNotification('فشل في تحميل المنتجات: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function displayProducts() {
    const tbody = document.getElementById('productsTableBody');
    
    if (filteredProducts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center" style="padding: 2rem; color: var(--gray-500);">
                    لا توجد منتجات
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredProducts.map(product => {
        const finalPrice = product.discount > 0 
            ? product.price - (product.price * product.discount / 100)
            : product.price;
        
        return `
            <tr>
                <td class="product-image-cell">
                    ${product.image ? 
                        `<img src="${product.image}" alt="${product.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 60 60\\'><rect width=\\'60\\' height=\\'60\\' fill=\\'#e9ecef\\'></rect><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' fill=\\'#6c757d\\'>لا صورة</text></svg>';">` : 
                        `<div style="width: 60px; height: 60px; background: var(--gray-200); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center;"><i class="fas fa-image"></i></div>`
                    }
                </td>
                <td>
                    <strong>${product.name}</strong>
                    ${product.badge ? `<br><small style="color: var(--secondary-color);">${product.badge}</small>` : ''}
                </td>
                <td>${categoryNames[product.category]}</td>
                <td>
                    <strong style="color: var(--success-color);">${finalPrice.toFixed(2)} جنيه</strong>
                    ${product.discount > 0 ? `<br><small style="text-decoration: line-through; color: var(--gray-500);">${product.price.toFixed(2)} جنيه</small>` : ''}
                </td>
                <td>${product.discount}%</td>
                <td>
                    <div style="color: #ffc107;">
                        ${'★'.repeat(product.rating)}${'☆'.repeat(5 - product.rating)}
                    </div>
                </td>
                <td>
                    <div class="product-actions">
                        <button class="btn btn-info btn-sm" onclick="editProduct('${product.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function updateStatistics() {
    document.getElementById('totalProducts').textContent = allProducts.length;
    document.getElementById('booksCount').textContent = allProducts.filter(p => p.category === 'books').length;
    document.getElementById('stationeryCount').textContent = allProducts.filter(p => p.category === 'stationery').length;
    document.getElementById('bagsCount').textContent = allProducts.filter(p => p.category === 'bags').length;
}

function filterProducts() {
    const searchTerm = document.getElementById('searchProducts').value.toLowerCase().trim();
    const categoryFilter = document.getElementById('filterCategory').value;
    
    filteredProducts = allProducts.filter(product => {
        const matchesSearch = !searchTerm || 
                             product.name.toLowerCase().includes(searchTerm) || 
                             product.description.toLowerCase().includes(searchTerm);
        const matchesCategory = !categoryFilter || product.category === categoryFilter;
        
        return matchesSearch && matchesCategory;
    });
    
    displayProducts();
}

async function deleteProduct(productId) {
    if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
        return;
    }
    
    showLoading();
    
    try {
        const product = allProducts.find(p => p.id === productId);
        if (!product) throw new Error('المنتج غير موجود');
        
        // Delete from Firestore
        await window.deleteDoc(window.doc(window.db, "products", productId));
        
        // Delete image from Storage if exists
        if (product.image) {
            try {
                const imageRef = window.ref(window.storage, product.image);
                await window.deleteObject(imageRef);
            } catch (error) {
                console.warn('Image deletion failed (might not exist):', error);
            }
        }
        
        showNotification('تم حذف المنتج بنجاح', 'success');
        await loadProducts();
        
    } catch (error) {
        console.error('Error deleting product:', error);
        showNotification('فشل في حذف المنتج: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function editProduct(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) {
        showNotification('المنتج غير موجود', 'error');
        return;
    }
    
    editingProductId = productId;
    
    // Fill edit form
    document.getElementById('editProductId').value = productId;
    document.getElementById('editProductName').value = product.name;
    document.getElementById('editProductCategory').value = product.category;
    document.getElementById('editProductPrice').value = product.price;
    document.getElementById('editProductDiscount').value = product.discount || 0;
    document.getElementById('editProductRating').value = product.rating;
    document.getElementById('editProductBadge').value = product.badge || '';
    document.getElementById('editProductDescription').value = product.description;
    
    // Show current image
    const editImagePreview = document.getElementById('editImagePreview');
    if (product.image) {
        editImagePreview.innerHTML = `
            <p>الصورة الحالية:</p>
            <img src="${product.image}" alt="${product.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 200 200\\'><rect width=\\'200\\' height=\\'200\\' fill=\\'#e9ecef\\'></rect><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' fill=\\'#6c757d\\'>لا صورة</text></svg>';">
        `;
    } else {
        editImagePreview.innerHTML = '<p>لا توجد صورة حالية</p>';
    }
    
    // Show modal
    document.getElementById('editModal').style.display = 'block';
}

async function updateProduct() {
    const formData = getEditFormData();
    if (!formData) return;
    
    showLoading();
    
    try {
        const existingProduct = allProducts.find(p => p.id === editingProductId);
        if (!existingProduct) throw new Error('المنتج غير موجود');
        
        let imageUrl = existingProduct.image || '';
        
        // Upload new image if selected
        const imageFile = document.getElementById('editProductImage').files[0];
        if (imageFile) {
            imageUrl = await uploadImage(imageFile);
            
            // Delete old image if it exists
            if (existingProduct.image) {
                try {
                    const oldImageRef = window.ref(window.storage, existingProduct.image);
                    await window.deleteObject(oldImageRef);
                } catch (error) {
                    console.warn('Old image deletion failed:', error);
                }
            }
        }
        
        // Update product in Firestore
        const productData = {
            ...formData,
            image: imageUrl,
            updatedAt: new Date().toISOString()
        };
        
        await window.updateDoc(window.doc(window.db, "products", editingProductId), productData);
        
        showNotification('تم تحديث المنتج بنجاح', 'success');
        closeEditModal();
        await loadProducts();
        
    } catch (error) {
        console.error('Error updating product:', error);
        showNotification('فشل في تحديث المنتج: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function getEditFormData() {
    const name = document.getElementById('editProductName').value.trim();
    const category = document.getElementById('editProductCategory').value;
    const price = parseFloat(document.getElementById('editProductPrice').value);
    const discount = parseInt(document.getElementById('editProductDiscount').value) || 0;
    const rating = parseInt(document.getElementById('editProductRating').value);
    const badge = document.getElementById('editProductBadge').value.trim();
    const description = document.getElementById('editProductDescription').value.trim();
    
    if (!name || !category || isNaN(price) || !description) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'warning');
        return null;
    }
    
    return {
        name,
        category,
        price,
        discount,
        rating,
        badge,
        description
    };
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    editingProductId = null;
    document.getElementById('editImagePreview').innerHTML = '';
    document.getElementById('editProductForm').reset();
}

async function confirmClearAll() {
    if (!confirm('⚠️ تحذير: هل أنت متأكد من حذف جميع المنتجات؟ لا يمكن التراجع عن هذا الإجراء!')) {
        return;
    }
    
    if (!confirm('هذا الإجراء سيحذف جميع المنتجات نهائياً. هل تريد المتابعة؟')) {
        return;
    }
    
    showLoading();
    
    try {
        const deletePromises = allProducts.map(async (product) => {
            // Delete from Firestore
            await window.deleteDoc(window.doc(window.db, "products", product.id));
            
            // Delete image from Storage if exists
            if (product.image) {
                try {
                    const imageRef = window.ref(window.storage, product.image);
                    await window.deleteObject(imageRef);
                } catch (error) {
                    console.warn('Image deletion failed:', error);
                }
            }
        });
        
        await Promise.all(deletePromises);
        
        showNotification('تم حذف جميع المنتجات بنجاح', 'success');
        await loadProducts();
        
    } catch (error) {
        console.error('Error clearing all products:', error);
        showNotification('فشل في حذف المنتجات: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

function exportProducts() {
    if (allProducts.length === 0) {
        showNotification('لا توجد منتجات للتصدير', 'warning');
        return;
    }
    
    const csvContent = generateCSV();
    downloadCSV(csvContent, 'products.csv');
    showNotification('تم تصدير البيانات بنجاح', 'success');
}

function generateCSV() {
    const headers = ['اسم المنتج', 'التصنيف', 'السعر', 'الخصم', 'التقييم', 'الوصف', 'الشارة', 'رابط الصورة'];
    const rows = allProducts.map(product => [
        product.name,
        categoryNames[product.category],
        product.price,
        product.discount || 0,
        product.rating,
        product.description,
        product.badge || '',
        product.image || ''
    ]);
    
    const csvContent = [headers, ...rows]
        .map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
        .join('\n');
    
    return '\ufeff' + csvContent; // Add BOM for Arabic support
}

function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Utility Functions
function resetForm() {
    document.getElementById('productForm').reset();
    document.getElementById('imagePreview').innerHTML = '';
}

function previewImage(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('imagePreview');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <p>معاينة الصورة:</p>
                <img src="${e.target.result}" alt="معاينة">
            `;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = '';
    }
}

function previewEditImage(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('editImagePreview');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <p>الصورة الجديدة:</p>
                <img src="${e.target.result}" alt="معاينة">
            `;
        };
        reader.readAsDataURL(file);
    }
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target === modal) {
        closeEditModal();
    }
};
</script>
</body>
</html>
